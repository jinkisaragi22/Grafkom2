<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
      }
      .webgl {
        background-color: gray;
      }
    </style>
  </head>

  <body>
    <canvas class="webgl"></canvas>
    <audio
      id="id-piano"
      src="./assets/horrorPianoBacksound.mp3"
      loop
      autoplay
    ></audio>
    <audio id="id-batu" src="./assets/suaraBatu.mp3"></audio>
    <audio id="id-kelelawar" src="./assets/batSound.mp3"></audio>
    <audio id="id-mumi" src="./assets/soundMumi.mp3"></audio>
    <audio id="id-demon" src="./assets/demonVoice.mp3"></audio>
    <audio id="id-spider" src="./assets/spiderAttack.mp3"></audio>
    <script src="three.js"></script>
    <script type="module" src="GLTFLoader.js"></script>
    <script type="module">
      const clock = new THREE.Clock();
      import { GLTFLoader } from "./GLTFLoader.js";
      import { OrbitControls } from "./OrbitControls.js";
      import { PointerLockControls } from "./PointerLockControls.js";

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.01,
        200
      );
      const canvas = document.querySelector(".webgl");
      const renderer = new THREE.WebGL1Renderer({
        canvas: canvas,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const piano = document.getElementById("id-piano");
      const audioBatu = document.getElementById("id-batu");
      const batSound = document.getElementById("id-kelelawar");
      const soundMumi = document.getElementById("id-mumi");
      const demon = document.getElementById("id-demon");
      const spiderAttack = document.getElementById("id-spider");
      const mixers = [];
      let pianoModel, pianoBox;
      let kelelawar1Model;
      let kelelawar2Model;
      let kelelawar3Model;
      let ularModel, ularBox, ularSpotLight;
      let hewan2Model;
      let hewan3Model;
      let hewan3Mixer, hewan3Action1, hewan3Action2;
      let patung1Model, patung1Box;
      let patung4Model, patung4Box;
      let patung5Model, patung5Box;
      let patung5Mixer, patung5Action;
      let movingLeft = true;
      let movingUp = true;
      let falling = false;
      let fallenAngle = 0;
      let arah = "right";
      const targetAngle = Math.PI / 2;
      let lampuMejaSpotLight;
      let timerId;
      let tembok1Model, tembok1Box, tembok2Model, tembok2Box;
      let lampu1Box, lampu2Box, lampu3Box;

      const loader = new GLTFLoader();
      const orbitcontrol = new OrbitControls(camera, renderer.domElement);
      orbitcontrol.update();
      const pointerlock = new PointerLockControls(camera, renderer.domElement);
      scene.background = new THREE.Color(0x2a2a27);

      loader.load("./assets/museum/museum.glb", function (gltf) {
        //ruangan
        const model = gltf.scene;
        model.position.set(27, 0, -35);
        model.scale.set(5, 5, 5);
        model.rotation.y = 1.6;
        scene.add(model);

        model.traverse((child) => {
          console.log(child);
          if (child.material && child.name != "ceiling") {
            console.log(child.material.map);
            const texture = child.material.map;
            child.material = new THREE.MeshPhongMaterial({
              map: texture,
            });
          }
        });
      });

      loader.load("./assets/patung1/scene.gltf", function (gltf) {
        //kuda
        const model = gltf.scene;
        model.position.set(45, 0, -24);
        model.scale.set(1, 1, 1);
        model.rotation.y = 4.5;
        scene.add(model);
        patung1Model = model;

        patung1Box = new THREE.Box3().setFromObject(patung1Model);

        //const helper = new THREE.Box3Helper(patung1Box, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/patung2/scene.gltf", function (gltf) {
        //ulo
        const model = gltf.scene;
        model.position.set(11, 0, -24);
        model.scale.set(1, 1, 1);
        model.rotation.y = 4.5;
        scene.add(model);

        ularModel = model;

        ularSpotLight = new THREE.SpotLight(0xff0000);
        ularSpotLight.position.set(
          ularModel.position.x + 3,
          ularModel.position.y + 10,
          ularModel.position.z
        );
        ularSpotLight.target.position.set(
          ularModel.position.x,
          0,
          ularModel.position.z
        );
        ularSpotLight.target.updateMatrixWorld();
        ularSpotLight.castShadow = true;
        ularSpotLight.intensity = 0;
        ularSpotLight.angle = Math.PI;
        ularSpotLight.distance = 50;
        ularSpotLight.penumbra = 0.5;
        ularSpotLight.decay = 3;

        // const sphelper = new THREE.SpotLightHelper(ularSpotLight);
        // scene.add(sphelper);

        scene.add(ularSpotLight);
        scene.add(ularSpotLight.target);

        ularBox = new THREE.Box3().setFromObject(ularModel);

        // const helper = new THREE.Box3Helper(ularBox, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/patung4/scene.gltf", function (gltf) {
        //mesir
        const model = gltf.scene;
        model.position.set(10, 0, -45);
        model.scale.set(0.5, 0.5, 0.5);
        model.rotation.y = 1.5;
        scene.add(model);
        patung4Model = model;

        patung4Box = new THREE.Box3().setFromObject(patung4Model);

        // const helper = new THREE.Box3Helper(patung4Box, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/patung5/scene.gltf", function (gltf) {
        // mumi
        const model = gltf.scene;
        model.position.set(45, -1.3, -45);
        model.scale.set(0.4, 0.4, 0.4);
        model.rotation.y = Math.PI * 1.5;
        scene.add(model);
        patung5Model = model;
        if (gltf.animations.length > 0) {
          patung5Mixer = new THREE.AnimationMixer(model);
          patung5Action = patung5Mixer.clipAction(gltf.animations[0]);
          mixers.push(patung5Mixer);
        }

        patung5Box = new THREE.Box3().setFromObject(patung5Model);

        // const helper = new THREE.Box3Helper(patung5Box, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/piano/scene.gltf", function (gltf) {
        //piano
        const model = gltf.scene;
        model.position.set(21, 2, -70);
        model.scale.set(0.006, 0.006, 0.006);
        scene.add(model);
        pianoModel = model;

        pianoBox = new THREE.Box3().setFromObject(pianoModel);

        // const helper = new THREE.Box3Helper(pianoBox, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/lampu1/scene.gltf", function (gltf) {
        //lampu pojok
        const model = gltf.scene;
        model.position.set(42, 5, -72);
        model.scale.set(5, 5, 5);
        model.rotation.y = 0.1;
        scene.add(model);

        const spotLight = new THREE.SpotLight(0xffd8b1);
        spotLight.position.set(42, 10, -72);
        spotLight.target.position.set(model.position.x, 0, model.position.z);
        spotLight.target.updateMatrixWorld();
        spotLight.castShadow = true;
        spotLight.intensity = 1.5;
        spotLight.angle = Math.PI / 3;
        spotLight.distance = 50;
        spotLight.penumbra = 1.5;
        spotLight.decay = 2;

        // const sphelper = new THREE.SpotLightHelper(spotLight);
        // scene.add(sphelper);

        scene.add(spotLight);
        scene.add(spotLight.target);

        lampu1Box = new THREE.Box3().setFromObject(model);

        // const helper = new THREE.Box3Helper(lampu1Box, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/lampu1/scene.gltf", function (gltf) {
        //lampu pojok
        const model = gltf.scene;
        model.position.set(44, 5, 2);
        model.scale.set(5, 5, 5);
        model.rotation.y = 0.1;
        scene.add(model);

        const spotLight = new THREE.SpotLight(0xffd8b1);
        spotLight.position.set(44, 10, -1);
        spotLight.target.position.set(model.position.x, 0, model.position.z);
        spotLight.target.updateMatrixWorld();
        spotLight.castShadow = true;
        spotLight.intensity = 1.5;
        spotLight.angle = Math.PI / 3;
        spotLight.distance = 50;
        spotLight.penumbra = 1.5;
        spotLight.decay = 2;

        // const sphelper = new THREE.SpotLightHelper(spotLight);
        // scene.add(sphelper);

        scene.add(spotLight);
        scene.add(spotLight.target);

        lampu2Box = new THREE.Box3().setFromObject(model);

        // const helper = new THREE.Box3Helper(lampu2Box, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/lampu1/scene.gltf", function (gltf) {
        //lampu pojok
        const model = gltf.scene;
        model.position.set(12, 5, 2);
        model.scale.set(5, 5, 5);
        model.rotation.y = 0.1;
        scene.add(model);

        const spotLight = new THREE.SpotLight(0xffd8b1);
        spotLight.position.set(10, 10, -1);
        spotLight.target.position.set(model.position.x, 0, model.position.z);
        spotLight.target.updateMatrixWorld();
        spotLight.castShadow = true;
        spotLight.intensity = 1.5;
        spotLight.angle = Math.PI / 3;
        spotLight.distance = 50;
        spotLight.penumbra = 1.5;
        spotLight.decay = 2;

        // const sphelper = new THREE.SpotLightHelper(spotLight);
        // scene.add(sphelper);

        scene.add(spotLight);
        scene.add(spotLight.target);

        lampu3Box = new THREE.Box3().setFromObject(model);

        // const helper = new THREE.Box3Helper(lampu3Box, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/lampu2/scene.gltf", function (gltf) {
        //lampu meja
        const model = gltf.scene;
        model.position.set(9.7, 3.7, -69.5);
        model.scale.set(0.05, 0.05, 0.05);
        scene.add(model);

        lampuMejaSpotLight = new THREE.SpotLight(0xffd8b1);
        lampuMejaSpotLight.position.set(9.7, 5.7, -69.5);
        lampuMejaSpotLight.target.position.set(
          model.position.x,
          0,
          model.position.z
        );
        lampuMejaSpotLight.target.updateMatrixWorld();
        lampuMejaSpotLight.castShadow = true;
        lampuMejaSpotLight.intensity = 1.5;
        lampuMejaSpotLight.angle = Math.PI / 4;
        lampuMejaSpotLight.distance = 50;
        lampuMejaSpotLight.penumbra = 1.5;
        lampuMejaSpotLight.decay = 3;

        //const sphelper = new THREE.SpotLightHelper(spotLight);
        //scene.add(sphelper);

        scene.add(lampuMejaSpotLight);
        scene.add(lampuMejaSpotLight.target);
      });

      loader.load("./assets/lampu3/scene.gltf", function (gltf) {
        //lampu nde kuda
        const model = gltf.scene;
        model.position.set(47, 8, -24.8);
        model.scale.set(1, 1, 1);
        model.rotation.y = Math.PI * 1.5;
        scene.add(model);

        const spotLight = new THREE.SpotLight(0xffd8b1);
        spotLight.position.set(45, 12, -24.4);
        spotLight.target.position.set(model.position.x, 0, model.position.z);
        spotLight.target.updateMatrixWorld();
        spotLight.castShadow = true;
        spotLight.intensity = 1.5;
        spotLight.angle = Math.PI / 3;
        spotLight.distance = 50;
        spotLight.penumbra = 1.5;
        spotLight.decay = 2;

        //const sphelper = new THREE.SpotLightHelper(spotLight);
        //scene.add(sphelper);

        scene.add(spotLight);
        scene.add(spotLight.target);
      });

      loader.load("./assets/hewan3/scene.gltf", function (gltf) {
        // laba - laba
        const model = gltf.scene;
        model.position.set(45, -0.1, -15);
        model.scale.set(0.01, 0.01, 0.01);
        scene.add(model);
        model.rotation.y = 4;
        hewan3Model = model;
        if (gltf.animations.length > 0) {
          hewan3Mixer = new THREE.AnimationMixer(model);
          hewan3Action1 = hewan3Mixer.clipAction(gltf.animations[1]);
          hewan3Action2 = hewan3Mixer.clipAction(gltf.animations[2]);
          hewan3Action1.play();
          mixers.push(hewan3Mixer);
        }
      });

      loader.load("./assets/hewan2/scene.gltf", function (gltf) {
        // kecoa
        const model = gltf.scene;
        model.position.set(7.7, 2, -12);
        model.scale.set(0.2, 0.2, 0.2);
        model.rotation.x = 1.5;
        model.rotation.y = 3.2;
        model.rotation.z = 2;
        scene.add(model);
        hewan2Model = model;
        if (gltf.animations.length > 0) {
          const mixer = new THREE.AnimationMixer(model);
          mixer.clipAction(gltf.animations[0]).play();
          mixers.push(mixer);
        }
      });

      loader.load("./assets/hewan1/scene.gltf", function (gltf) {
        // kelelawar
        const model = gltf.scene;
        model.position.set(10, 23, -2);
        model.scale.set(1, 1, 1);
        scene.add(model);
        kelelawar1Model = model;
        if (gltf.animations.length > 0) {
          const mixer = new THREE.AnimationMixer(model);
          mixer.clipAction(gltf.animations[0]).play();
          mixers.push(mixer);
        }
      });

      loader.load("./assets/hewan1/scene.gltf", function (gltf) {
        // kelelawar
        const model = gltf.scene;
        model.position.set(16, 10, -75);
        model.rotation.y = Math.PI * 1.5;
        model.scale.set(1, 1, 1);
        scene.add(model);
        kelelawar2Model = model;
        if (gltf.animations.length > 0) {
          const mixer = new THREE.AnimationMixer(model);
          mixer.clipAction(gltf.animations[0]).play();
          mixers.push(mixer);
        }
      });

      loader.load("./assets/hewan1/scene.gltf", function (gltf) {
        // kelelawar
        const model = gltf.scene;
        model.position.set(13, 10, -75);
        model.rotation.y = Math.PI * 1.5;
        model.scale.set(1, 1, 1);
        scene.add(model);
        kelelawar3Model = model;
        if (gltf.animations.length > 0) {
          const mixer = new THREE.AnimationMixer(model);
          mixer.clipAction(gltf.animations[0]).play();
          mixers.push(mixer);
        }
      });

      loader.load("./assets/tembok/scene.gltf", function (gltf) {
        //tembok 1
        const model = gltf.scene;
        model.position.set(10, 9, -42);
        model.scale.set(4, 7, 5);
        model.rotation.y = Math.PI / 2;
        scene.add(model);

        tembok1Model = model;

        tembok1Box = new THREE.Box3().setFromObject(tembok1Model);

        // const helper = new THREE.Box3Helper(tembok1Box, 0xff0000);
        // scene.add(helper);
      });

      loader.load("./assets/tembok/scene.gltf", function (gltf) {
        //tembok 2
        const model = gltf.scene;
        model.position.set(45, 9, -43);
        model.scale.set(4, 7, 5);
        model.rotation.y = Math.PI / 2;
        scene.add(model);

        tembok2Model = model;

        tembok2Box = new THREE.Box3().setFromObject(tembok2Model);

        // const helper = new THREE.Box3Helper(tembok2Box, 0xff0000);
        // scene.add(helper);
      });

      const keyboard = {};
      document.addEventListener("keydown", function (e) {
        keyboard[e.key] = true;
        if (e.key == "x") {
          pointerlock.lock();
        }
      });
      document.addEventListener("keyup", function (e) {
        keyboard[e.key] = false;
      });

      document.addEventListener("click", function () {
        pointerlock.lock();
      });

      const light = new THREE.HemisphereLight(0xffffff, 0x000000, 0.7);
      scene.add(light);
      camera.position.set(27, 6, -3);
      // camera.position.set(27, 5, -60);
      // camera.lookAt(12,5,-60)

      const boundaries = {
        minX: 10,
        maxX: 45,
        minY: 7.7,
        maxY: 8,
        minZ: -75,
        maxZ: 2,
      };

      function animate() {
        requestAnimationFrame(animate);

        const delta = clock.getDelta();
        mixers.forEach((mixer) => mixer.update(delta));

        const moveSpeed = 5;
        const direction = new THREE.Vector3();
        camera.getWorldDirection(direction);
        direction.normalize();

        const right = new THREE.Vector3();
        right.crossVectors(camera.up, direction).normalize();

        let newPosition = camera.position.clone();

        if (keyboard["w"]) {
          newPosition.addScaledVector(direction, moveSpeed * delta);
        }
        if (keyboard["s"]) {
          newPosition.addScaledVector(direction, -moveSpeed * delta);
        }
        if (keyboard["a"]) {
          newPosition.addScaledVector(right, moveSpeed * delta);
        }
        if (keyboard["d"]) {
          newPosition.addScaledVector(right, -moveSpeed * delta);
        }

        if (newPosition.x < boundaries.minX) newPosition.x = boundaries.minX;
        if (newPosition.x > boundaries.maxX) newPosition.x = boundaries.maxX;
        if (newPosition.y < boundaries.minY) newPosition.y = boundaries.minY;
        if (newPosition.y > boundaries.maxY) newPosition.y = boundaries.maxY;
        if (newPosition.z < boundaries.minZ) newPosition.z = boundaries.minZ;
        if (newPosition.z > boundaries.maxZ) newPosition.z = boundaries.maxZ;

        camera.position.copy(newPosition);

        if (ularBox) {
          // cek kamera di dalem box ato ngga
          if (ularBox.containsPoint(camera.position)) {
            // Kalo iya, dorong kamera kebelakang
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (patung1Box) {
          if (patung1Box.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (patung4Box) {
          if (patung4Box.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (patung5Box) {
          if (patung5Box.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (pianoBox) {
          if (pianoBox.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (lampu2Box) {
          if (lampu2Box.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (lampu1Box) {
          if (lampu1Box.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (lampu3Box) {
          if (lampu3Box.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (tembok1Box) {
          if (tembok1Box.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        if (tembok2Box) {
          if (tembok2Box.containsPoint(camera.position)) {
            const direction = camera.getWorldDirection(new THREE.Vector3());
            camera.position.sub(direction.multiplyScalar(0.1));
          }
        }

        // pengecekan lampu merah nyala di patung ular
        if (ularModel) {
          const distance = camera.position.distanceTo(ularModel.position);
          if (distance < 13) {
            ularSpotLight.intensity = 1.5;
            demon.play();
          } else {
            ularSpotLight.intensity = 0;
            demon.pause();
          }
        }

        // pengecekan animasi pas ndeket ke piano
        if (pianoModel) {
          const distance = camera.position.distanceTo(pianoModel.position);
          if (distance < 15) {
            piano.pause();
            kelelawar2Model.position.z += delta * 100;
            kelelawar3Model.position.z += delta * 100;
            batSound.play();

            if (!timerId) {
              timerId = setInterval(() => {
                lampuMejaSpotLight.intensity =
                  lampuMejaSpotLight.intensity === 0 ? 1.5 : 0;
              }, 200);
            }
          } else {
            piano.play();
            batSound.pause();
            if (timerId) {
              clearInterval(timerId);
              timerId = null;
              lampuMejaSpotLight.intensity = 1.5;
            }
          }
        }

        // pengecekan arah liat patung kuda
        if (patung1Model) {
          patung1Model.lookAt(camera.position);
        }

        // pengecekan pergerakan kelelawar
        if (kelelawar1Model) {
          //console.log(`Current direction: ${arah}`);
          //console.log(
          //  `Position: x=${kelelawar1Model.position.x}, z=${kelelawar1Model.position.z}`
          //);

          if (arah === "right") {
            if (kelelawar1Model.position.x < 40) {
              kelelawar1Model.position.x += delta * 10;
            } else {
              arah = "forward";
              kelelawar1Model.rotation.y = Math.PI / 2;
            }
          } else if (arah === "forward") {
            if (kelelawar1Model.position.z > -70) {
              kelelawar1Model.position.z -= delta * 10;
            } else {
              arah = "left";
              kelelawar1Model.rotation.y = Math.PI / 2;
            }
          } else if (arah === "left") {
            if (kelelawar1Model.position.x > 15) {
              kelelawar1Model.position.x -= delta * 10;
            } else {
              arah = "backward";
              kelelawar1Model.rotation.y = Math.PI / 2;
            }
          } else if (arah === "backward") {
            if (kelelawar1Model.position.z < -2) {
              kelelawar1Model.position.z += delta * 10;
            } else {
              arah = "right";
              kelelawar1Model.rotation.y = Math.PI;
            }
          }
        }

        // pengecekan animasi kecoa
        if (hewan2Model) {
          if (movingUp) {
            hewan2Model.position.y += delta;
            if (hewan2Model.position.y >= 12) {
              movingUp = false;
              hewan2Model.rotation.x += Math.PI;
            }
          } else {
            hewan2Model.position.y -= delta;
            if (hewan2Model.position.y <= 2) {
              movingUp = true;
              hewan2Model.rotation.x += Math.PI;
            }
          }
        }

        if (hewan3Model) {
          const distance = camera.position.distanceTo(hewan3Model.position);
          if (distance < 10) {
            hewan3Action1.stop();
            hewan3Action2.play();
            spiderAttack.play();
          } else {
            hewan3Action2.stop();
            hewan3Action1.play();
            spiderAttack.pause();
          }
          if (movingLeft) {
            hewan3Model.position.x -= delta * 3;
            if (hewan3Model.position.x <= 10) {
              movingLeft = false;
              hewan3Model.rotation.y = 1;
            }
          } else {
            hewan3Model.position.x += delta * 3;
            if (hewan3Model.position.x >= 45) {
              movingLeft = true;
              hewan3Model.rotation.y = 4;
            }
          }
        }

        // pengecekan patung mesir jatuh
        if (patung4Model) {
          const distance = camera.position.distanceTo(patung4Model.position);
          if (distance < 10 && fallenAngle < targetAngle) {
            const rotateStep = Math.PI / 60;
            patung4Model.rotation.z += rotateStep;
            patung4Model.position.y += rotateStep;
            fallenAngle += rotateStep;
            if (fallenAngle <= targetAngle) {
              audioBatu.play();
            }
          }
        }

        if (patung5Model) {
          const distance = camera.position.distanceTo(patung5Model.position);
          if (distance < 15) {
            patung5Action.play();
            soundMumi.play();
          } else {
            patung5Action.stop();
          }
        }

        renderer.render(scene, camera);
      }
      animate();
    </script>
  </body>
</html>
